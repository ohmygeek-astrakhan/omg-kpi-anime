<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OH MY GEEK ‚Ä¢ Focus Tracker v3.2</title>
  <style>
    :root{
      --bg:#0a0f1a; --card:#111827; --card-hover:#1a2236; --line:rgba(255,255,255,.08);
      --txt:#e6edf7; --muted:#8b9cb3; --a:#4fd1ff; --p:#ff4fd8;
      --g:#22c55e; --y:#f59e0b; --r:#ef4444; --purple:#a78bfa;
      --rad:14px; --shadow:0 4px 20px rgba(0,0,0,.3);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Inter',system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--txt);min-height:100vh}
    
    .header{background:linear-gradient(135deg, #111827 0%, #1e293b 100%);border-bottom:1px solid var(--line);padding:16px 24px;position:sticky;top:0;z-index:100}
    .header-inner{max-width:1600px;margin:0 auto;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px}
    .logo{display:flex;align-items:center;gap:12px}
    .logo h1{font-size:18px;font-weight:700;background:linear-gradient(135deg,var(--a),var(--p));-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .logo-badge{font-size:10px;background:var(--p);color:#fff;padding:3px 8px;border-radius:20px;font-weight:600}
    .header-actions{display:flex;gap:8px;flex-wrap:wrap}
    
    .btn{border:1px solid var(--line);background:rgba(255,255,255,.03);color:var(--txt);
      padding:10px 16px;border-radius:10px;cursor:pointer;font-size:13px;font-weight:500;
      transition:all .15s ease;display:inline-flex;align-items:center;gap:6px}
    .btn:hover{background:rgba(255,255,255,.08);border-color:rgba(255,255,255,.15);transform:translateY(-1px)}
    .btn.primary{border-color:rgba(79,209,255,.4);background:linear-gradient(135deg,rgba(79,209,255,.15),rgba(167,139,250,.15));color:#fff}
    .btn.primary:hover{background:linear-gradient(135deg,rgba(79,209,255,.25),rgba(167,139,250,.25))}
    .btn.success{border-color:rgba(34,197,94,.4);background:rgba(34,197,94,.12);color:#86efac}
    .btn.danger{border-color:rgba(239,68,68,.4);background:rgba(239,68,68,.12);color:#fca5a5}
    .btn.small{padding:6px 12px;font-size:12px}
    
    .focus-banner{background:linear-gradient(135deg, rgba(79,209,255,.1) 0%, rgba(255,79,216,.1) 100%);
      border:1px solid rgba(79,209,255,.2);border-radius:16px;padding:20px 24px;margin:20px 24px;max-width:1600px;margin-left:auto;margin-right:auto}
    .focus-banner h2{font-size:14px;color:var(--muted);font-weight:500;margin-bottom:8px;display:flex;align-items:center;gap:8px}
    .focus-banner h2::before{content:"üéØ"}
    .focus-title{font-size:20px;font-weight:700;margin-bottom:12px}
    .focus-meta{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
    .focus-next{font-size:14px;color:var(--muted);padding:12px;background:rgba(0,0,0,.2);border-radius:10px;margin-bottom:12px}
    .focus-next strong{color:var(--a)}
    .focus-actions{display:flex;gap:8px;flex-wrap:wrap}
    
    .main{padding:0 24px 24px;max-width:1600px;margin:0 auto}
    
    .tabs{display:flex;gap:4px;margin-bottom:20px;background:var(--card);padding:4px;border-radius:12px;width:fit-content}
    .tab{padding:10px 20px;border-radius:8px;cursor:pointer;font-size:13px;font-weight:500;color:var(--muted);transition:all .15s}
    .tab:hover{color:var(--txt)}
    .tab.active{background:linear-gradient(135deg,rgba(79,209,255,.2),rgba(167,139,250,.2));color:#fff}
    
    .kanban{display:grid;grid-template-columns:repeat(3, 1fr);gap:16px;min-height:500px}
    @media(max-width:1100px){.kanban{grid-template-columns:1fr}}
    
    .kanban-column{background:var(--card);border:1px solid var(--line);border-radius:var(--rad);display:flex;flex-direction:column;min-height:400px}
    .kanban-header{padding:16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    .kanban-title{font-weight:600;font-size:14px;display:flex;align-items:center;gap:8px}
    .kanban-count{font-size:12px;background:rgba(255,255,255,.1);padding:4px 10px;border-radius:20px;color:var(--muted)}
    .kanban-body{flex:1;padding:12px;overflow-y:auto;min-height:200px}
    
    .col-todo .kanban-header{border-left:3px solid var(--y)}
    .col-doing .kanban-header{border-left:3px solid var(--p)}
    .col-done .kanban-header{border-left:3px solid var(--g)}
    
    .task-card{background:rgba(255,255,255,.02);border:1px solid var(--line);border-radius:12px;padding:14px;margin-bottom:10px;
      cursor:grab;transition:all .2s ease;position:relative}
    .task-card:hover{background:var(--card-hover);border-color:rgba(255,255,255,.12);transform:translateY(-2px);box-shadow:var(--shadow)}
    .task-card.dragging{opacity:.5;transform:rotate(3deg)}
    
    .task-priority{position:absolute;top:0;left:0;width:4px;height:100%;border-radius:12px 0 0 12px}
    .task-priority.critical{background:var(--r)}
    .task-priority.important{background:var(--y)}
    .task-priority.growth{background:var(--a)}
    .task-priority.later{background:var(--muted)}
    
    .task-title{font-weight:600;font-size:14px;margin-bottom:8px;padding-left:8px}
    .task-meta{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px;padding-left:8px}
    .task-next{font-size:12px;color:var(--muted);padding:8px 10px;background:rgba(0,0,0,.2);border-radius:8px;margin-bottom:8px}
    .task-contact{font-size:12px;color:var(--a);padding:6px 10px;background:rgba(79,209,255,.1);border-radius:8px;margin-bottom:8px;display:flex;align-items:center;gap:6px}
    .task-contact::before{content:"üìû"}
    .task-actions{display:flex;gap:6px;padding-left:8px;flex-wrap:wrap}
    
    /* Progress bar */
    .task-progress{margin:8px 0 8px 8px}
    .progress-track{height:6px;background:rgba(255,255,255,.1);border-radius:10px;overflow:hidden;cursor:pointer;position:relative}
    .progress-fill{height:100%;background:linear-gradient(90deg,var(--y),var(--g));border-radius:10px;transition:width .2s}
    .progress-label{font-size:11px;color:var(--muted);margin-top:4px;display:flex;justify-content:space-between}
    .progress-label span{cursor:pointer;padding:2px 6px;border-radius:4px}
    .progress-label span:hover{background:rgba(255,255,255,.1)}
    
    .pill{font-size:11px;padding:4px 10px;border-radius:20px;font-weight:500;white-space:nowrap}
    .pill.critical{background:rgba(239,68,68,.15);color:#fca5a5;border:1px solid rgba(239,68,68,.3)}
    .pill.important{background:rgba(245,158,11,.15);color:#fcd34d;border:1px solid rgba(245,158,11,.3)}
    .pill.growth{background:rgba(79,209,255,.15);color:#7dd3fc;border:1px solid rgba(79,209,255,.3)}
    .pill.later{background:rgba(255,255,255,.05);color:var(--muted);border:1px solid var(--line)}
    .pill.store{background:rgba(167,139,250,.15);color:#c4b5fd;border:1px solid rgba(167,139,250,.3)}
    .pill.owner{background:rgba(34,197,94,.15);color:#86efac;border:1px solid rgba(34,197,94,.3)}
    .pill.overdue{background:rgba(239,68,68,.2);color:#fca5a5;border:1px solid rgba(239,68,68,.4);animation:pulse 2s infinite}
    .pill.due{background:rgba(245,158,11,.15);color:#fcd34d;border:1px solid rgba(245,158,11,.3)}
    
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.6}}
    
    .quick-add{background:var(--card);border:1px solid var(--line);border-radius:var(--rad);padding:20px;margin-bottom:20px}
    .quick-add h3{font-size:14px;margin-bottom:16px;display:flex;align-items:center;gap:8px}
    .quick-add h3::before{content:"‚ö°"}
    .quick-form{display:grid;grid-template-columns:2fr 1fr 1fr 1fr auto;gap:12px;align-items:end}
    @media(max-width:900px){.quick-form{grid-template-columns:1fr 1fr;}}
    @media(max-width:600px){.quick-form{grid-template-columns:1fr;}}
    
    .form-group label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .form-group input,.form-group select,.form-group textarea{width:100%;border:1px solid var(--line);background:rgba(255,255,255,.03);
      color:var(--txt);padding:12px;border-radius:10px;outline:none;font-size:14px;transition:border-color .15s}
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus{border-color:var(--a)}
    .form-group input::placeholder,.form-group textarea::placeholder{color:var(--muted)}
    .form-group textarea{min-height:80px;resize:vertical;font-family:inherit}
    
    .stats-bar{display:flex;gap:16px;margin-bottom:20px;flex-wrap:wrap}
    .stat-item{background:var(--card);border:1px solid var(--line);border-radius:12px;padding:16px 24px;min-width:140px}
    .stat-value{font-size:28px;font-weight:700}
    .stat-value.text-green{color:var(--g)}
    .stat-value.text-yellow{color:var(--y)}
    .stat-value.text-red{color:var(--r)}
    .stat-label{font-size:12px;color:var(--muted);margin-top:4px}
    
    .progress-bar-big{height:8px;background:rgba(255,255,255,.1);border-radius:10px;overflow:hidden;margin-top:8px}
    .progress-fill-big{height:100%;background:linear-gradient(90deg,var(--g),var(--a));border-radius:10px;transition:width .3s}
    
    /* Journal */
    .journal{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-top:20px}
    @media(max-width:900px){.journal{grid-template-columns:1fr}}
    .journal-card{background:var(--card);border:1px solid var(--line);border-radius:var(--rad);padding:16px}
    .journal-card h4{font-size:13px;color:var(--muted);margin-bottom:10px;display:flex;align-items:center;gap:6px}
    .journal-card textarea{width:100%;border:1px solid var(--line);background:rgba(255,255,255,.02);
      color:var(--txt);padding:12px;border-radius:10px;outline:none;min-height:100px;resize:vertical;font-size:14px;line-height:1.5}
    .journal-card textarea:focus{border-color:var(--a)}
    .journal-status{font-size:11px;color:var(--g);margin-top:8px;opacity:0;transition:opacity .3s}
    .journal-status.show{opacity:1}
    
    /* Contacts */
    .contacts-grid{display:grid;grid-template-columns:repeat(auto-fill, minmax(300px, 1fr));gap:16px}
    .contact-card{background:var(--card);border:1px solid var(--line);border-radius:var(--rad);padding:16px;transition:all .2s}
    .contact-card:hover{border-color:rgba(79,209,255,.3);transform:translateY(-2px)}
    .contact-name{font-weight:600;font-size:16px;margin-bottom:8px}
    .contact-info{display:flex;flex-direction:column;gap:6px}
    .contact-row{display:flex;align-items:center;gap:8px;font-size:13px;color:var(--muted)}
    .contact-row a{color:var(--a);text-decoration:none}
    .contact-row a:hover{text-decoration:underline}
    .contact-tasks{margin-top:12px;padding-top:12px;border-top:1px solid var(--line)}
    .contact-tasks-title{font-size:12px;color:var(--muted);margin-bottom:8px}
    .contact-task-item{font-size:12px;padding:6px 10px;background:rgba(255,255,255,.03);border-radius:6px;margin-bottom:4px}
    
    .add-contact-form{background:var(--card);border:1px solid var(--line);border-radius:var(--rad);padding:20px;margin-bottom:20px}
    .add-contact-form h3{font-size:14px;margin-bottom:16px}
    .add-contact-grid{display:grid;grid-template-columns:1fr 1fr 1fr auto;gap:12px;align-items:end}
    @media(max-width:800px){.add-contact-grid{grid-template-columns:1fr 1fr}}
    @media(max-width:500px){.add-contact-grid{grid-template-columns:1fr}}
    
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;padding:20px;z-index:200;backdrop-filter:blur(4px)}
    .modal.open{display:flex}
    .modal-box{background:var(--card);border:1px solid var(--line);border-radius:18px;padding:24px;max-width:800px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .modal-title{font-size:18px;font-weight:600}
    
    .report-text{width:100%;border:1px solid var(--line);background:rgba(0,0,0,.3);
      color:var(--txt);padding:16px;border-radius:12px;min-height:400px;font-family:'JetBrains Mono',monospace;font-size:13px;line-height:1.6;resize:vertical}
    
    .edit-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:600px){.edit-grid{grid-template-columns:1fr}}
    .edit-full{grid-column:1/-1}
    
    .empty-state{text-align:center;padding:40px;color:var(--muted)}
    .empty-state-icon{font-size:48px;margin-bottom:12px}
    
    .fade-in{animation:fadeIn .3s ease}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
    
    ::-webkit-scrollbar{width:6px;height:6px}
    ::-webkit-scrollbar-track{background:transparent}
    ::-webkit-scrollbar-thumb{background:var(--line);border-radius:3px}
    ::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.2)}
    
    .section{display:none}
    .section.active{display:block}
  </style>
</head>
<body>

<header class="header">
  <div class="header-inner">
    <div class="logo">
      <h1>OH MY GEEK ‚Ä¢ Focus Tracker</h1>
      <span class="logo-badge">v3.2</span>
    </div>
    <div class="header-actions">
      <button class="btn" id="reportBtn">üìä –û—Ç—á—ë—Ç</button>
      <button class="btn" id="exportBtn">üíæ –≠–∫—Å–ø–æ—Ä—Ç</button>
      <label class="btn" for="importFile">üìÇ –ò–º–ø–æ—Ä—Ç</label>
      <input id="importFile" type="file" accept="application/json" style="display:none" />
      <button class="btn danger" id="resetBtn">üóë –°–±—Ä–æ—Å</button>
    </div>
  </div>
</header>

<div class="focus-banner" id="focusBanner">
  <h2>–û–¥–Ω–∞ –∑–∞–¥–∞—á–∞ —Å–µ–π—á–∞—Å <span id="focusMode" class="pill later">–∞–≤—Ç–æ–≤—ã–±–æ—Ä</span></h2>
  <div class="focus-title" id="focusTitle">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  <div class="focus-meta" id="focusMeta"></div>
  <div class="focus-next" id="focusNext"><strong>–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:</strong> ‚Äî</div>
  <div class="focus-actions" id="focusActions"></div>
</div>

<div class="main">
  <div class="tabs">
    <div class="tab active" data-tab="kanban">üìã Kanban</div>
    <div class="tab" data-tab="contacts">üìá –ö–æ–Ω—Ç–∞–∫—Ç—ã</div>
    <div class="tab" data-tab="journal">üìù –î–Ω–µ–≤–Ω–∏–∫</div>
    <div class="tab" data-tab="stats">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
  </div>

  <!-- Kanban -->
  <section class="section active" id="kanban">
    <div class="quick-add">
      <h3>–ë—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É</h3>
      <div class="quick-form">
        <div class="form-group">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
          <input id="qTitle" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–¢–û–õ –¥–ª—è –¢—Ä–∏ –ö–æ—Ç–∞" />
        </div>
        <div class="form-group">
          <label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
          <select id="qPriority">
            <option value="critical">üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ</option>
            <option value="important">üü° –í–∞–∂–Ω–æ</option>
            <option value="growth">üîµ –†–∞–∑–≤–∏—Ç–∏–µ</option>
            <option value="later">‚ö™ –û—Ç–ª–æ–∂–∏—Ç—å</option>
          </select>
        </div>
        <div class="form-group">
          <label>–ú–∞–≥–∞–∑–∏–Ω</label>
          <select id="qStore">
            <option value="–û—Ñ–∏—Å/–û–Ω–ª–∞–π–Ω">üè¢ –û—Ñ–∏—Å</option>
            <option value="–ê–ª–∏–º–ø–∏–∫">üõí –ê–ª–∏–º–ø–∏–∫</option>
            <option value="–Ø—Ä–º–∞—Ä–∫–∞">üõí –Ø—Ä–º–∞—Ä–∫–∞</option>
            <option value="–¢—Ä–∏ –ö–æ—Ç–∞">üê± –¢—Ä–∏ –ö–æ—Ç–∞</option>
          </select>
        </div>
        <div class="form-group">
          <label>–°—Ä–æ–∫</label>
          <input id="qDue" type="date" />
        </div>
        <button class="btn primary" id="addBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>

    <div class="kanban">
      <div class="kanban-column col-todo" data-status="todo">
        <div class="kanban-header">
          <div class="kanban-title">üìã –°–¥–µ–ª–∞—Ç—å</div>
          <div class="kanban-count" id="countTodo">0</div>
        </div>
        <div class="kanban-body" id="colTodo"></div>
      </div>
      
      <div class="kanban-column col-doing" data-status="doing">
        <div class="kanban-header">
          <div class="kanban-title">üî• –í —Ä–∞–±–æ—Ç–µ <span style="font-size:11px;color:var(--muted)">(–º–∞–∫—Å. 3)</span></div>
          <div class="kanban-count" id="countDoing">0</div>
        </div>
        <div class="kanban-body" id="colDoing"></div>
      </div>
      
      <div class="kanban-column col-done" data-status="done">
        <div class="kanban-header">
          <div class="kanban-title">‚úÖ –ì–æ—Ç–æ–≤–æ</div>
          <div class="kanban-count" id="countDone">0</div>
        </div>
        <div class="kanban-body" id="colDone"></div>
      </div>
    </div>
  </section>

  <!-- Contacts -->
  <section class="section" id="contacts">
    <div class="add-contact-form">
      <h3>‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç</h3>
      <div class="add-contact-grid">
        <div class="form-group">
          <label>–ò–º—è / –ö–æ–º–ø–∞–Ω–∏—è</label>
          <input id="cName" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –≠–ö–û–¶–ï–ù–¢–†" />
        </div>
        <div class="form-group">
          <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
          <input id="cPhone" placeholder="+7 900 000-00-00" />
        </div>
        <div class="form-group">
          <label>–ó–∞–º–µ—Ç–∫–∞</label>
          <input id="cNote" placeholder="–í—ã–≤–æ–∑ –º—É—Å–æ—Ä–∞, –º–µ–Ω–µ–¥–∂–µ—Ä –ò–≤–∞–Ω" />
        </div>
        <button class="btn primary" id="addContactBtn">‚ûï</button>
      </div>
    </div>
    
    <div class="contacts-grid" id="contactsList"></div>
  </section>

  <!-- Journal -->
  <section class="section" id="journal">
    <div class="journal">
      <div class="journal-card">
        <h4>‚úÖ –ß—Ç–æ —Å–¥–µ–ª–∞–ª —Å–µ–≥–æ–¥–Ω—è</h4>
        <textarea id="jDone" placeholder="–§–∞–∫—Ç—ã: —á—Ç–æ —É–¥–∞–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å..."></textarea>
        <div class="journal-status" id="jDoneStatus">üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</div>
      </div>
      <div class="journal-card">
        <h4>üöß –ì–¥–µ –∑–∞—Å—Ç—Ä—è–ª / –Ω–µ —Å–¥–µ–ª–∞–ª</h4>
        <textarea id="jStuck" placeholder="–ß—Ç–æ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –∏ –ø–æ—á–µ–º—É..."></textarea>
        <div class="journal-status" id="jStuckStatus">üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</div>
      </div>
      <div class="journal-card">
        <h4>üéØ –ó–∞–≤—Ç—Ä–∞</h4>
        <textarea id="jNext" placeholder="–û–¥–Ω–∞ –≥–ª–∞–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ + 1-2 –≤—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã—Ö..."></textarea>
        <div class="journal-status" id="jNextStatus">üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</div>
      </div>
    </div>
    <div style="margin-top:16px;display:flex;gap:8px;align-items:center">
      <span style="font-size:13px;color:var(--g)">‚úì –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ</span>
    </div>
  </section>

  <!-- Stats -->
  <section class="section" id="stats">
    <div class="stats-bar">
      <div class="stat-item">
        <div class="stat-value" id="statTotal">0</div>
        <div class="stat-label">–í—Å–µ–≥–æ –∑–∞–¥–∞—á</div>
      </div>
      <div class="stat-item">
        <div class="stat-value text-green" id="statDone">0</div>
        <div class="stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
      </div>
      <div class="stat-item">
        <div class="stat-value text-yellow" id="statDoing">0</div>
        <div class="stat-label">–í —Ä–∞–±–æ—Ç–µ</div>
      </div>
      <div class="stat-item">
        <div class="stat-value text-red" id="statOverdue">0</div>
        <div class="stat-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
      </div>
      <div class="stat-item" style="flex:1">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <span class="stat-label">–ü—Ä–æ–≥—Ä–µ—Å—Å</span>
          <span id="statPercent">0%</span>
        </div>
        <div class="progress-bar-big">
          <div class="progress-fill-big" id="progressFill" style="width:0%"></div>
        </div>
      </div>
    </div>

    <div class="quick-add">
      <h3>üìä –§–æ—Ä–º—É–ª–∞ –∞–≤—Ç–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞</h3>
      <p style="color:var(--muted);font-size:14px;line-height:1.6">
        <strong>–°–∫–æ—Ä</strong> = –ë–∞–∑–∞ + –ü—Ä–æ—Å—Ä–æ—á–∫–∞√ó50–ö + –°–∫–æ—Ä–æ√ó20–ö + –ó–∞–¥–µ—Ä–∂–∫–∞‚ÇΩ/–¥–µ–Ω—å + –ü—Ä–æ–≥—Ä–µ—Å—Å√ó500<br><br>
        ‚Ä¢ <span style="color:var(--r)">–ö—Ä–∏—Ç–∏—á–Ω–æ</span> = 400–ö &nbsp;
        ‚Ä¢ <span style="color:var(--y)">–í–∞–∂–Ω–æ</span> = 250–ö &nbsp;
        ‚Ä¢ <span style="color:var(--a)">–†–∞–∑–≤–∏—Ç–∏–µ</span> = 120–ö &nbsp;
        ‚Ä¢ <span style="color:var(--muted)">–û—Ç–ª–æ–∂–∏—Ç—å</span> = 20–ö
      </p>
    </div>
  </section>
</div>

<!-- Report Modal -->
<div class="modal" id="reportModal">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title">üìä –û—Ç—á—ë—Ç –¥–Ω—è</div>
      <div style="display:flex;gap:8px">
        <button class="btn small" id="copyReport">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
        <button class="btn small danger" id="closeReport">‚úï</button>
      </div>
    </div>
    <textarea class="report-text" id="reportText"></textarea>
  </div>
</div>

<!-- Edit Modal -->
<div class="modal" id="editModal">
  <div class="modal-box">
    <div class="modal-header">
      <div class="modal-title">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É</div>
      <button class="btn small danger" id="closeEdit">‚úï</button>
    </div>
    <div class="edit-grid">
      <div class="form-group edit-full">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
        <input id="eTitle" />
      </div>
      <div class="form-group">
        <label>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç</label>
        <select id="ePriority">
          <option value="critical">üî¥ –ö—Ä–∏—Ç–∏—á–Ω–æ</option>
          <option value="important">üü° –í–∞–∂–Ω–æ</option>
          <option value="growth">üîµ –†–∞–∑–≤–∏—Ç–∏–µ</option>
          <option value="later">‚ö™ –û—Ç–ª–æ–∂–∏—Ç—å</option>
        </select>
      </div>
      <div class="form-group">
        <label>–°—Ç–∞—Ç—É—Å</label>
        <select id="eStatus">
          <option value="todo">üìã –°–¥–µ–ª–∞—Ç—å</option>
          <option value="doing">üî• –í —Ä–∞–±–æ—Ç–µ</option>
          <option value="done">‚úÖ –ì–æ—Ç–æ–≤–æ</option>
        </select>
      </div>
      <div class="form-group">
        <label>–ú–∞–≥–∞–∑–∏–Ω</label>
        <select id="eStore">
          <option value="–û—Ñ–∏—Å/–û–Ω–ª–∞–π–Ω">üè¢ –û—Ñ–∏—Å</option>
          <option value="–ê–ª–∏–º–ø–∏–∫">üõí –ê–ª–∏–º–ø–∏–∫</option>
          <option value="–Ø—Ä–º–∞—Ä–∫–∞">üõí –Ø—Ä–º–∞—Ä–∫–∞</option>
          <option value="–¢—Ä–∏ –ö–æ—Ç–∞">üê± –¢—Ä–∏ –ö–æ—Ç–∞</option>
        </select>
      </div>
      <div class="form-group">
        <label>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</label>
        <input id="eOwner" placeholder="–ü—ë—Ç—Ä / –î–º–∏—Ç—Ä–∏–π" />
      </div>
      <div class="form-group">
        <label>–°—Ä–æ–∫</label>
        <input id="eDue" type="date" />
      </div>
      <div class="form-group">
        <label>–ó–∞–¥–µ—Ä–∂–∫–∞ (‚ÇΩ/–¥–µ–Ω—å)</label>
        <input id="eDelay" type="number" placeholder="5000" />
      </div>
      <div class="form-group">
        <label>–ü—Ä–æ–≥—Ä–µ—Å—Å: <span id="eProgressLabel">0%</span></label>
        <input id="eProgress" type="range" min="0" max="100" step="10" value="0" style="width:100%;cursor:pointer" />
      </div>
      <div class="form-group edit-full">
        <label>–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥</label>
        <input id="eNext" placeholder="–ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞ 5-15 –º–∏–Ω..." />
      </div>
      <div class="form-group edit-full">
        <label>üìû –ö–æ–Ω—Ç–∞–∫—Ç (—Ç–µ–ª–µ—Ñ–æ–Ω, –∏–º—è)</label>
        <input id="eContact" placeholder="+7 900 000-00-00, –ò–≤–∞–Ω –∏–∑ –≠–ö–û–¶–ï–ù–¢–†" />
      </div>
    </div>
    <div style="margin-top:20px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn primary" id="saveEdit">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      <button class="btn" id="pinTask">üìå –ó–∞–∫—Ä–µ–ø–∏—Ç—å</button>
      <button class="btn success" id="completeTask">‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
      <button class="btn danger" id="deleteTask">üóë –£–¥–∞–ª–∏—Ç—å</button>
    </div>
  </div>
</div>

<script>
const KEY = "omg_focus_v3";
const today = () => new Date().toISOString().slice(0,10);
const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

const PRIORITIES = {
  critical: {name:"–ö—Ä–∏—Ç–∏—á–Ω–æ", emoji:"üî¥", base:400000},
  important: {name:"–í–∞–∂–Ω–æ", emoji:"üü°", base:250000},
  growth: {name:"–†–∞–∑–≤–∏—Ç–∏–µ", emoji:"üîµ", base:120000},
  later: {name:"–û—Ç–ª–æ–∂–∏—Ç—å", emoji:"‚ö™", base:20000}
};

const MAX_DOING = 3;

let state = loadState();
let editingId = null;
let draggedId = null;

function loadState() {
  try {
    const raw = localStorage.getItem(KEY);
    if (raw) {
      const s = JSON.parse(raw);
      if (!s.contacts) s.contacts = [];
      // Migrate tasks: add progress if missing
      s.tasks = s.tasks.map(t => ({...t, progress: t.progress || 0, contact: t.contact || ''}));
      return s;
    }
  } catch(e) {}
  return getDefaultState();
}

function getDefaultState() {
  return {
    pinnedId: null,
    tasks: [
      {id:uid(), title:"–ê–¢–û–õ –¥–ª—è –¢—Ä–∏ –ö–æ—Ç–∞", priority:"critical", status:"todo", due:"2026-02-20",
        store:"–¢—Ä–∏ –ö–æ—Ç–∞", owner:"–ü—ë—Ç—Ä", delay:8000, next:"–ó–∞–∫–∞–∑–∞—Ç—å –ê–¢–û–õ (15 –º–∏–Ω)", progress:0, contact:"",
        createdAt:new Date().toISOString(), doneAt:null},
    ],
    contacts: [
      {id:uid(), name:"–≠–ö–û–¶–ï–ù–¢–†", phone:"9275697291", note:"–í—ã–≤–æ–∑ –º—É—Å–æ—Ä–∞"},
    ],
    journal: {}
  };
}

function saveState() {
  localStorage.setItem(KEY, JSON.stringify(state));
}

// === SCORING ===
function scoreTask(t) {
  let score = (PRIORITIES[t.priority] || PRIORITIES.important).base;
  score += Number(t.delay) || 0;
  score += (t.progress || 0) * 500; // Boost tasks with progress
  
  if (t.due && t.status !== 'done') {
    const days = daysDiff(today(), t.due);
    if (days < 0) score += Math.abs(days) * 50000;
    else if (days <= 2) score += 20000;
  }
  if (t.status === 'doing') score += 60000;
  return score;
}

function daysDiff(from, to) {
  return Math.round((new Date(to+'T00:00:00Z') - new Date(from+'T00:00:00Z')) / 86400000);
}

function isOverdue(t) {
  return t.due && t.status !== 'done' && new Date(t.due) < new Date(today());
}

function sortTasks(tasks) {
  return [...tasks].sort((a, b) => scoreTask(b) - scoreTask(a));
}

function getFocus() {
  const pinned = state.tasks.find(t => t.id === state.pinnedId && t.status !== 'done');
  if (pinned) return {task: pinned, mode: '–∑–∞–∫—Ä–µ–ø–ª–µ–Ω–æ'};
  const sorted = sortTasks(state.tasks.filter(t => t.status !== 'done'));
  return {task: sorted[0] || null, mode: '–∞–≤—Ç–æ–≤—ã–±–æ—Ä'};
}

// === RENDER ===
function render() {
  renderFocus();
  renderKanban();
  renderContacts();
  renderStats();
}

function renderFocus() {
  const {task, mode} = getFocus();
  document.getElementById('focusMode').textContent = mode;
  
  if (!task) {
    document.getElementById('focusTitle').textContent = 'üéâ –í—Å–µ –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!';
    document.getElementById('focusMeta').innerHTML = '';
    document.getElementById('focusNext').innerHTML = '<strong>–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:</strong> –î–æ–±–∞–≤—å –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É';
    document.getElementById('focusActions').innerHTML = '';
    return;
  }
  
  document.getElementById('focusTitle').textContent = task.title;
  
  const pr = PRIORITIES[task.priority] || PRIORITIES.important;
  const overdue = isOverdue(task);
  
  let meta = `<span class="pill ${task.priority}">${pr.emoji} ${pr.name}</span>`;
  if (task.store) meta += `<span class="pill store">üìç ${task.store}</span>`;
  if (task.owner) meta += `<span class="pill owner">üë§ ${task.owner}</span>`;
  if (task.progress > 0) meta += `<span class="pill growth">üìä ${task.progress}%</span>`;
  if (overdue) meta += `<span class="pill overdue">‚ö†Ô∏è –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>`;
  else if (task.due) {
    const days = daysDiff(today(), task.due);
    if (days === 0) meta += `<span class="pill due">üî• –°–µ–≥–æ–¥–Ω—è</span>`;
    else if (days > 0 && days <= 2) meta += `<span class="pill due">‚è∞ ${days} –¥–Ω.</span>`;
  }
  
  document.getElementById('focusMeta').innerHTML = meta;
  
  let nextHtml = `<strong>–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:</strong> ${task.next || '‚Äî'}`;
  if (task.contact) nextHtml += `<br><span style="color:var(--a)">üìû ${escapeHtml(task.contact)}</span>`;
  document.getElementById('focusNext').innerHTML = nextHtml;
  
  document.getElementById('focusActions').innerHTML = `
    <button class="btn primary" onclick="setStatus('${task.id}', 'doing')">üî• –í —Ä–∞–±–æ—Ç—É</button>
    <button class="btn success" onclick="setStatus('${task.id}', 'done')">‚úÖ –ì–æ—Ç–æ–≤–æ</button>
    <button class="btn" onclick="quickProgress('${task.id}')">üìä +10%</button>
    <button class="btn" onclick="openEdit('${task.id}')">‚úèÔ∏è</button>
  `;
}

function renderKanban() {
  const columns = {
    todo: document.getElementById('colTodo'),
    doing: document.getElementById('colDoing'),
    done: document.getElementById('colDone')
  };
  
  Object.keys(columns).forEach(status => {
    let tasks = state.tasks.filter(t => t.status === status);
    if (status === 'done') {
      // Show only today's done
      const d = today();
      tasks = tasks.filter(t => t.doneAt && t.doneAt.slice(0,10) === d);
    }
    tasks = sortTasks(tasks);
    const col = columns[status];
    
    document.getElementById(`count${status.charAt(0).toUpperCase() + status.slice(1)}`).textContent = 
      status === 'done' ? state.tasks.filter(t => t.status === 'done').length : tasks.length;
    
    if (tasks.length === 0) {
      col.innerHTML = `<div class="empty-state"><div class="empty-state-icon">${status === 'done' ? 'üéØ' : 'üì≠'}</div>–ü—É—Å—Ç–æ</div>`;
      return;
    }
    
    col.innerHTML = tasks.map(t => renderTaskCard(t)).join('');
    
    col.querySelectorAll('.task-card').forEach(card => {
      card.draggable = true;
      card.addEventListener('dragstart', handleDragStart);
      card.addEventListener('dragend', handleDragEnd);
    });
  });
  
  document.querySelectorAll('.kanban-body').forEach(body => {
    body.addEventListener('dragover', handleDragOver);
    body.addEventListener('dragleave', handleDragLeave);
    body.addEventListener('drop', handleDrop);
  });
}

function renderTaskCard(t) {
  const pr = PRIORITIES[t.priority] || PRIORITIES.important;
  const overdue = isOverdue(t);
  const progress = t.progress || 0;
  
  let meta = '';
  if (t.store) meta += `<span class="pill store">${t.store}</span>`;
  if (t.owner) meta += `<span class="pill owner">${t.owner}</span>`;
  if (overdue) meta += `<span class="pill overdue">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</span>`;
  else if (t.due) {
    const days = daysDiff(today(), t.due);
    if (days === 0) meta += `<span class="pill due">–°–µ–≥–æ–¥–Ω—è</span>`;
    else if (days > 0 && days <= 3) meta += `<span class="pill due">${days} –¥–Ω.</span>`;
  }
  
  const progressHtml = t.status !== 'done' ? `
    <div class="task-progress">
      <div class="progress-track" onclick="cycleProgress('${t.id}', event)">
        <div class="progress-fill" style="width:${progress}%"></div>
      </div>
      <div class="progress-label">
        <span onclick="setProgress('${t.id}', 0)">0%</span>
        <span onclick="setProgress('${t.id}', 25)">25%</span>
        <span onclick="setProgress('${t.id}', 50)">50%</span>
        <span onclick="setProgress('${t.id}', 75)">75%</span>
        <span onclick="setProgress('${t.id}', 100)">100%</span>
      </div>
    </div>
  ` : '';
  
  const contactHtml = t.contact ? `<div class="task-contact">${escapeHtml(t.contact)}</div>` : '';
  
  return `
    <div class="task-card fade-in" data-id="${t.id}">
      <div class="task-priority ${t.priority}"></div>
      <div class="task-title">${escapeHtml(t.title)}</div>
      <div class="task-meta">${meta}</div>
      ${progressHtml}
      ${t.next ? `<div class="task-next">‚Üí ${escapeHtml(t.next)}</div>` : ''}
      ${contactHtml}
      <div class="task-actions">
        ${t.status !== 'done' ? `<button class="btn small primary" onclick="setStatus('${t.id}', 'doing')">üî•</button>` : ''}
        ${t.status !== 'done' ? `<button class="btn small success" onclick="setStatus('${t.id}', 'done')">‚úÖ</button>` : ''}
        <button class="btn small" onclick="openEdit('${t.id}')">‚úèÔ∏è</button>
      </div>
    </div>
  `;
}

function renderContacts() {
  const list = document.getElementById('contactsList');
  
  if (state.contacts.length === 0) {
    list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">üìá</div>–ù–µ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤</div>';
    return;
  }
  
  list.innerHTML = state.contacts.map(c => {
    const relatedTasks = state.tasks.filter(t => 
      t.contact && t.contact.toLowerCase().includes(c.name.toLowerCase()) ||
      t.contact && c.phone && t.contact.includes(c.phone)
    );
    
    const tasksHtml = relatedTasks.length > 0 ? `
      <div class="contact-tasks">
        <div class="contact-tasks-title">–°–≤—è–∑–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏:</div>
        ${relatedTasks.slice(0,3).map(t => `<div class="contact-task-item">${escapeHtml(t.title)}</div>`).join('')}
      </div>
    ` : '';
    
    return `
      <div class="contact-card fade-in">
        <div class="contact-name">${escapeHtml(c.name)}</div>
        <div class="contact-info">
          ${c.phone ? `<div class="contact-row">üìû <a href="tel:${c.phone}">${escapeHtml(c.phone)}</a></div>` : ''}
          ${c.note ? `<div class="contact-row">üìù ${escapeHtml(c.note)}</div>` : ''}
        </div>
        ${tasksHtml}
        <div style="margin-top:12px">
          <button class="btn small danger" onclick="deleteContact('${c.id}')">üóë</button>
        </div>
      </div>
    `;
  }).join('');
}

function renderStats() {
  const total = state.tasks.length;
  const done = state.tasks.filter(t => t.status === 'done').length;
  const doing = state.tasks.filter(t => t.status === 'doing').length;
  const overdue = state.tasks.filter(t => isOverdue(t)).length;
  const percent = total > 0 ? Math.round((done / total) * 100) : 0;
  
  document.getElementById('statTotal').textContent = total;
  document.getElementById('statDone').textContent = done;
  document.getElementById('statDoing').textContent = doing;
  document.getElementById('statOverdue').textContent = overdue;
  document.getElementById('statPercent').textContent = percent + '%';
  document.getElementById('progressFill').style.width = percent + '%';
}

// === PROGRESS ===
function setProgress(id, value) {
  const task = state.tasks.find(t => t.id === id);
  if (!task) return;
  task.progress = value;
  if (value === 100 && task.status !== 'done') {
    task.status = 'done';
    task.doneAt = new Date().toISOString();
    if (state.pinnedId === id) state.pinnedId = null;
  }
  saveState();
  render();
}

function cycleProgress(id, event) {
  event.stopPropagation();
  const task = state.tasks.find(t => t.id === id);
  if (!task) return;
  const steps = [0, 25, 50, 75, 100];
  const idx = steps.indexOf(task.progress || 0);
  task.progress = steps[(idx + 1) % steps.length];
  if (task.progress === 100 && task.status !== 'done') {
    task.status = 'done';
    task.doneAt = new Date().toISOString();
    if (state.pinnedId === id) state.pinnedId = null;
  }
  saveState();
  render();
}

function quickProgress(id) {
  const task = state.tasks.find(t => t.id === id);
  if (!task) return;
  task.progress = Math.min(100, (task.progress || 0) + 10);
  if (task.progress === 100 && task.status !== 'done') {
    task.status = 'done';
    task.doneAt = new Date().toISOString();
    if (state.pinnedId === id) state.pinnedId = null;
  }
  saveState();
  render();
}

// === DRAG & DROP ===
function handleDragStart(e) {
  draggedId = e.target.dataset.id;
  e.target.classList.add('dragging');
  e.dataTransfer.effectAllowed = 'move';
}

function handleDragEnd(e) {
  e.target.classList.remove('dragging');
  draggedId = null;
}

function handleDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
}

function handleDragLeave(e) {}

function handleDrop(e) {
  e.preventDefault();
  if (!draggedId) return;
  const column = e.currentTarget.closest('.kanban-column');
  if (!column) return;
  setStatus(draggedId, column.dataset.status, true);
}

// === ACTIONS ===
function setStatus(id, status, fromDrag = false) {
  const task = state.tasks.find(t => t.id === id);
  if (!task) return;
  
  if (status === 'doing') {
    const currentDoing = state.tasks.filter(t => t.status === 'doing' && t.id !== id);
    if (currentDoing.length >= MAX_DOING) {
      alert(`‚ö†Ô∏è –ú–∞–∫—Å–∏–º—É–º ${MAX_DOING} –∑–∞–¥–∞—á–∏ –≤ —Ä–∞–±–æ—Ç–µ!`);
      return;
    }
  }
  
  task.status = status;
  if (status === 'done') {
    task.doneAt = new Date().toISOString();
    task.progress = 100;
    if (state.pinnedId === id) state.pinnedId = null;
  }
  
  saveState();
  render();
}

function addTask() {
  const title = document.getElementById('qTitle').value.trim();
  if (!title) return;
  
  state.tasks.push({
    id: uid(),
    title,
    priority: document.getElementById('qPriority').value,
    status: 'todo',
    store: document.getElementById('qStore').value,
    due: document.getElementById('qDue').value,
    owner: '–ü—ë—Ç—Ä',
    delay: 0,
    next: '',
    progress: 0,
    contact: '',
    createdAt: new Date().toISOString(),
    doneAt: null
  });
  
  document.getElementById('qTitle').value = '';
  document.getElementById('qDue').value = '';
  saveState();
  render();
}

function openEdit(id) {
  editingId = id;
  const task = state.tasks.find(t => t.id === id);
  if (!task) return;
  
  document.getElementById('eTitle').value = task.title || '';
  document.getElementById('ePriority').value = task.priority || 'important';
  document.getElementById('eStatus').value = task.status || 'todo';
  document.getElementById('eStore').value = task.store || '–û—Ñ–∏—Å/–û–Ω–ª–∞–π–Ω';
  document.getElementById('eOwner').value = task.owner || '';
  document.getElementById('eDue').value = task.due || '';
  document.getElementById('eDelay').value = task.delay || '';
  document.getElementById('eNext').value = task.next || '';
  document.getElementById('eProgress').value = task.progress || 0;
  document.getElementById('eProgressLabel').textContent = (task.progress || 0) + '%';
  document.getElementById('eContact').value = task.contact || '';
  
  document.getElementById('editModal').classList.add('open');
}

function saveEdit() {
  const task = state.tasks.find(t => t.id === editingId);
  if (!task) return;
  
  const newStatus = document.getElementById('eStatus').value;
  
  if (newStatus === 'doing' && task.status !== 'doing') {
    const currentDoing = state.tasks.filter(t => t.status === 'doing');
    if (currentDoing.length >= MAX_DOING) {
      alert(`‚ö†Ô∏è –ú–∞–∫—Å–∏–º—É–º ${MAX_DOING} –∑–∞–¥–∞—á–∏ –≤ —Ä–∞–±–æ—Ç–µ!`);
      return;
    }
  }
  
  task.title = document.getElementById('eTitle').value.trim();
  task.priority = document.getElementById('ePriority').value;
  task.status = newStatus;
  task.store = document.getElementById('eStore').value;
  task.owner = document.getElementById('eOwner').value.trim();
  task.due = document.getElementById('eDue').value;
  task.delay = parseInt(document.getElementById('eDelay').value) || 0;
  task.next = document.getElementById('eNext').value.trim();
  task.progress = parseInt(document.getElementById('eProgress').value) || 0;
  task.contact = document.getElementById('eContact').value.trim();
  
  if (newStatus === 'done' && !task.doneAt) {
    task.doneAt = new Date().toISOString();
    task.progress = 100;
  }
  
  // Auto-add contact if new
  if (task.contact && task.contact.length > 5) {
    const phone = task.contact.match(/[\d\+\-\s\(\)]{7,}/)?.[0]?.replace(/\D/g,'');
    const existing = state.contacts.find(c => c.phone && phone && c.phone.includes(phone));
    if (!existing && phone) {
      const name = task.contact.replace(/[\d\+\-\s\(\)]+/g, '').trim() || task.title.split(' ')[0];
      state.contacts.push({id: uid(), name, phone, note: `–ò–∑ –∑–∞–¥–∞—á–∏: ${task.title}`});
    }
  }
  
  saveState();
  document.getElementById('editModal').classList.remove('open');
  render();
}

function deleteTask() {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) return;
  state.tasks = state.tasks.filter(t => t.id !== editingId);
  if (state.pinnedId === editingId) state.pinnedId = null;
  saveState();
  document.getElementById('editModal').classList.remove('open');
  render();
}

function pinTask() {
  state.pinnedId = editingId;
  saveState();
  document.getElementById('editModal').classList.remove('open');
  render();
}

function completeTask() {
  setStatus(editingId, 'done');
  document.getElementById('editModal').classList.remove('open');
}

// === CONTACTS ===
function addContact() {
  const name = document.getElementById('cName').value.trim();
  const phone = document.getElementById('cPhone').value.trim();
  const note = document.getElementById('cNote').value.trim();
  
  if (!name) return;
  
  state.contacts.push({id: uid(), name, phone, note});
  
  document.getElementById('cName').value = '';
  document.getElementById('cPhone').value = '';
  document.getElementById('cNote').value = '';
  
  saveState();
  render();
}

function deleteContact(id) {
  if (!confirm('–£–¥–∞–ª–∏—Ç—å –∫–æ–Ω—Ç–∞–∫—Ç?')) return;
  state.contacts = state.contacts.filter(c => c.id !== id);
  saveState();
  render();
}

// === JOURNAL (Auto-save) ===
function loadJournal() {
  const j = state.journal[today()] || {};
  document.getElementById('jDone').value = j.done || '';
  document.getElementById('jStuck').value = j.stuck || '';
  document.getElementById('jNext').value = j.next || '';
}

function saveJournal() {
  if (!state.journal[today()]) state.journal[today()] = {};
  state.journal[today()].done = document.getElementById('jDone').value;
  state.journal[today()].stuck = document.getElementById('jStuck').value;
  state.journal[today()].next = document.getElementById('jNext').value;
  saveState();
}

function showSaveStatus(field) {
  const el = document.getElementById(field + 'Status');
  if (el) {
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 2000);
  }
}

// Auto-save journal on every change
['jDone', 'jStuck', 'jNext'].forEach(id => {
  const el = document.getElementById(id);
  el.addEventListener('input', () => {
    saveJournal();
    showSaveStatus(id);
  });
});

// === REPORT ===
function generateReport() {
  const d = today();
  const active = sortTasks(state.tasks.filter(t => t.status !== 'done'));
  const doneToday = state.tasks.filter(t => t.status === 'done' && t.doneAt && t.doneAt.slice(0,10) === d);
  const overdue = state.tasks.filter(t => isOverdue(t));
  const j = state.journal[d] || {};
  const {task} = getFocus();
  
  let r = `OH MY GEEK ‚Ä¢ –û—Ç—á—ë—Ç –¥–Ω—è ‚Ä¢ ${d}\n${'='.repeat(50)}\n\n`;
  
  r += `üéØ –§–û–ö–£–°:\n`;
  if (task) {
    r += `‚Ä¢ ${task.title} [${task.store || '‚Äî'}]\n`;
    r += `  –û—Ç–≤–µ—Ç: ${task.owner || '‚Äî'} | –°—Ä–æ–∫: ${task.due || '‚Äî'} | –ü—Ä–æ–≥—Ä–µ—Å—Å: ${task.progress || 0}%\n`;
    if (task.contact) r += `  üìû ${task.contact}\n`;
    r += `  –®–∞–≥: ${task.next || '‚Äî'}\n`;
  } else r += `‚Ä¢ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö\n`;
  
  r += `\nüìã –ê–ö–¢–ò–í–ù–´–ï (${active.length}):\n`;
  if (!active.length) r += `‚Ä¢ –ù–µ—Ç\n`;
  active.slice(0,10).forEach((t,i) => {
    r += `${i+1}. ${t.title} [${t.store || '‚Äî'}] | ${t.progress||0}% | ${t.due || '–±–µ–∑ —Å—Ä–æ–∫–∞'}\n`;
  });
  
  r += `\n‚úÖ –ó–ê–ö–†–´–¢–û –°–ï–ì–û–î–ù–Ø (${doneToday.length}):\n`;
  if (!doneToday.length) r += `‚Ä¢ –ù–µ—Ç\n`;
  doneToday.forEach((t,i) => r += `${i+1}. ${t.title}\n`);
  
  r += `\n‚ö†Ô∏è –ü–†–û–°–†–û–ß–ö–ò (${overdue.length}):\n`;
  if (!overdue.length) r += `‚Ä¢ –ù–µ—Ç\n`;
  overdue.forEach((t,i) => r += `${i+1}. ${t.title} (—Å—Ä–æ–∫: ${t.due})\n`);
  
  r += `\nüìù –î–ù–ï–í–ù–ò–ö:\n`;
  r += `–°–¥–µ–ª–∞–ª: ${j.done || '‚Äî'}\n`;
  r += `–ó–∞—Å—Ç—Ä—è–ª: ${j.stuck || '‚Äî'}\n`;
  r += `–ó–∞–≤—Ç—Ä–∞: ${j.next || '‚Äî'}\n`;
  
  r += `\n${'='.repeat(50)}\n${new Date().toLocaleString('ru')}\n`;
  return r;
}

function showReport() {
  document.getElementById('reportText').value = generateReport();
  document.getElementById('reportModal').classList.add('open');
}

async function copyReport() {
  try { await navigator.clipboard.writeText(document.getElementById('reportText').value); alert('–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!'); } catch {}
}

// === EXPORT/IMPORT ===
function exportData() {
  const blob = new Blob([JSON.stringify(state, null, 2)], {type: 'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `OMG_FocusTracker_${today()}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
}

function importData(e) {
  const file = e.target.files?.[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = (ev) => {
    try {
      const data = JSON.parse(ev.target.result);
      if (data && Array.isArray(data.tasks)) {
        if (!data.contacts) data.contacts = [];
        data.tasks = data.tasks.map(t => ({...t, progress: t.progress || 0, contact: t.contact || ''}));
        state = data;
        saveState();
        render();
        loadJournal();
        alert('–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ!');
      }
    } catch { alert('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞'); }
  };
  reader.readAsText(file);
  e.target.value = '';
}

function resetData() {
  if (!confirm('–°–±—Ä–æ—Å–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ?')) return;
  localStorage.removeItem(KEY);
  state = loadState();
  render();
  loadJournal();
}

// === TABS ===
function switchTab(name) {
  // Save journal before switching
  saveJournal();
  
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`.tab[data-tab="${name}"]`).classList.add('active');
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.getElementById(name).classList.add('active');
}

// === UTILS ===
function escapeHtml(str) {
  return (str || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#039;"}[c]));
}

// === EVENT LISTENERS ===
document.getElementById('addBtn').addEventListener('click', addTask);
document.getElementById('qTitle').addEventListener('keypress', e => { if (e.key === 'Enter') addTask(); });

document.getElementById('addContactBtn').addEventListener('click', addContact);
document.getElementById('cName').addEventListener('keypress', e => { if (e.key === 'Enter') addContact(); });

document.querySelectorAll('.tab').forEach(t => {
  t.addEventListener('click', () => switchTab(t.dataset.tab));
});

document.getElementById('reportBtn').addEventListener('click', showReport);
document.getElementById('closeReport').addEventListener('click', () => document.getElementById('reportModal').classList.remove('open'));
document.getElementById('copyReport').addEventListener('click', copyReport);

document.getElementById('closeEdit').addEventListener('click', () => document.getElementById('editModal').classList.remove('open'));
document.getElementById('saveEdit').addEventListener('click', saveEdit);
document.getElementById('deleteTask').addEventListener('click', deleteTask);
document.getElementById('pinTask').addEventListener('click', pinTask);
document.getElementById('completeTask').addEventListener('click', completeTask);

document.getElementById('eProgress').addEventListener('input', e => {
  document.getElementById('eProgressLabel').textContent = e.target.value + '%';
});

document.getElementById('exportBtn').addEventListener('click', exportData);
document.getElementById('importFile').addEventListener('change', importData);
document.getElementById('resetBtn').addEventListener('click', resetData);

document.querySelectorAll('.modal').forEach(modal => {
  modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('open'); });
});

// === INIT ===
render();
loadJournal();
</script>
</body>
</html>
